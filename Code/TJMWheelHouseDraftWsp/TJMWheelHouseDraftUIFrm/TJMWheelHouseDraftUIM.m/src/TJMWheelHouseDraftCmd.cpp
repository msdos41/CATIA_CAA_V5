// COPYRIGHT Dassault Systemes 2021
//===================================================================
//
// TJMWheelHouseDraftCmd.cpp
// The state chart based command: TJMWheelHouseDraftCmd
//
//===================================================================
//
// Usage notes:
//
//===================================================================
//
//  Jan 2021  Creation: Code generated by the CAA wizard  Administrator
//===================================================================
#include "TJMWheelHouseDraftCmd.h"
#include "CATIndicationAgent.h"
#include "CATMathPlane.h"

#include "CATCreateExternalObject.h"
CATCreateClass( TJMWheelHouseDraftCmd);


//-------------------------------------------------------------------------
// Constructor
//-------------------------------------------------------------------------
TJMWheelHouseDraftCmd::TJMWheelHouseDraftCmd() :
  CATStateCommand ("TJMWheelHouseDraftCmd", CATDlgEngOneShot, CATCommandModeExclusive) 
//  Valid states are CATDlgEngOneShot and CATDlgEngRepeat
,_pDlg(NULL)
,_pEditor(NULL)
,_pHSO(NULL)
,_pSketchAgent(NULL)
,_pLineAgent(NULL)
,_pSurfaceAgent(NULL)
,_pSketchFieldAgent(NULL)
,_pToolingDirFieldAgent(NULL)
,_pSurfaceFieldAgent(NULL)
,_intSelType(0)
{
	_pDlg = new TJMWheelHouseDraftDlg();
	_pDlg->Build();
	_pDlg->SetVisibility(CATDlgShow);

	_pEditor=CATFrmEditor::GetCurrentEditor();
	if (NULL == _pEditor)
	{
		cout<<"GetCurrentEditor Failed"<<endl;
		RequestDelayedDestruction();
		return;
	}

	_pHSO=_pEditor->GetHSO();

	if (!TJMWheelHouseDraftGeneralClass::GetCurrentActiveProduct(_pEditor,_spiRootProduct)||_spiRootProduct==NULL_var)
	{
		cout<<"GetCurrentActiveProduct Failed"<<endl;
		RequestDelayedDestruction();
		return;
	}
	

	InitialDlg();
}

//-------------------------------------------------------------------------
// Destructor
//-------------------------------------------------------------------------
TJMWheelHouseDraftCmd::~TJMWheelHouseDraftCmd()
{
	if (_pDlg != NULL)
	{
		_pDlg->RequestDelayedDestruction();
		_pDlg = NULL;
	}

	if (_pLineAgent!=NULL)
	{
		_pLineAgent->RequestDelayedDestruction();
		_pLineAgent=NULL;
	}

	if (_pSketchAgent!=NULL)
	{
		_pSketchAgent->RequestDelayedDestruction();
		_pSketchAgent=NULL;
	}

	if (_pSketchFieldAgent!=NULL)
	{
		_pSketchFieldAgent->RequestDelayedDestruction();
		_pSketchFieldAgent=NULL;
	}

	if (_pToolingDirFieldAgent!=NULL)
	{
		_pToolingDirFieldAgent->RequestDelayedDestruction();
		_pToolingDirFieldAgent=NULL;
	}

	if (_pSurfaceAgent!=NULL)
	{
		_pSurfaceAgent->RequestDelayedDestruction();
		_pSurfaceAgent=NULL;
	}

	if (_pSurfaceFieldAgent!=NULL)
	{
		_pSurfaceFieldAgent->RequestDelayedDestruction();
		_pSurfaceFieldAgent=NULL;
	}

	if (_pHSO!=NULL)
	{
		_pHSO->Empty();
		_pHSO = NULL;
	}
}


//-------------------------------------------------------------------------
// BuildGraph()
//-------------------------------------------------------------------------
void TJMWheelHouseDraftCmd::BuildGraph()
{
	AddAnalyseNotificationCB(_pDlg,
		_pDlg->GetDiaCLOSENotification(),
		(CATCommandMethod)&TJMWheelHouseDraftCmd::ActionCancelFunc,
		NULL);

	AddAnalyseNotificationCB(_pDlg,
		_pDlg->GetWindCloseNotification(),
		(CATCommandMethod)&TJMWheelHouseDraftCmd::ActionCancelFunc,
		NULL);

	AddAnalyseNotificationCB(_pDlg,
		_pDlg->GetDiaCANCELNotification(),
		(CATCommandMethod)&TJMWheelHouseDraftCmd::ActionCancelFunc,
		NULL);

	AddAnalyseNotificationCB(_pDlg,
		_pDlg->GetDiaOKNotification(),
		(CATCommandMethod)&TJMWheelHouseDraftCmd::ActionOKFunc,
		NULL);

	CATAcquisitionFilter * pFilterSelected = Filter((FilterMethod) &TJMWheelHouseDraftCmd::CheckSelectedElement,(void *)NULL);

	//Sketch选择
	_pSketchAgent = new CATPathElementAgent("Select Sketch");
	_pSketchAgent->SetElementType("CATISketch");
	_pSketchAgent->SetBehavior(CATDlgEngWithPrevaluation|CATDlgEngWithCSO|CATDlgEngWithPSOHSO|CATDlgEngOneShot);
	_pSketchAgent->SetFilter(pFilterSelected);

	//Line选择
	_pLineAgent = new CATPathElementAgent("Select Line");
	_pLineAgent->SetElementType("CATLine");
	_pLineAgent->SetBehavior(CATDlgEngWithPrevaluation|CATDlgEngWithCSO|CATDlgEngWithPSOHSO|CATDlgEngOneShot);
	_pLineAgent->SetFilter(pFilterSelected);

	//Surface选择
	_pSurfaceAgent = new CATPathElementAgent("Select Surface");
	_pSurfaceAgent->SetElementType("CATIMeasurableSurface");
	_pSurfaceAgent->SetBehavior(CATDlgEngWithPrevaluation|CATDlgEngWithCSO|CATDlgEngWithPSOHSO|CATDlgEngOneShot);
	_pSurfaceAgent->SetFilter(pFilterSelected);

	_pSurfaceFieldAgent = new CATDialogAgent("Select A Surface Field");
	_pSurfaceFieldAgent->AcceptOnNotify(_pDlg->GetSelectorListFunc(0),
										_pDlg->GetSelectorListFunc(0)->GetListSelectNotification());
	
	_pSketchFieldAgent = new CATDialogAgent("Select A Sketch Field");
	_pSketchFieldAgent->AcceptOnNotify(_pDlg->GetSelectorListFunc(1),
										_pDlg->GetSelectorListFunc(1)->GetListSelectNotification());

	_pToolingDirFieldAgent = new CATDialogAgent("Select Tooling Dir Field");
	_pToolingDirFieldAgent->AcceptOnNotify(_pDlg->GetSelectorListFunc(2),
											_pDlg->GetSelectorListFunc(2)->GetListSelectNotification());


	CATDialogState *pSurfState = GetInitialState("Select WheelHouse Surface");
	pSurfState->AddDialogAgent(_pSurfaceAgent);
	pSurfState->AddDialogAgent(_pSurfaceFieldAgent);
	pSurfState->AddDialogAgent(_pToolingDirFieldAgent);
	pSurfState->AddDialogAgent(_pSketchFieldAgent);

	CATDialogState *pSketchState = AddDialogState("Select Hole Sketch");
	pSketchState->AddDialogAgent(_pSketchAgent);
	pSketchState->AddDialogAgent(_pSurfaceFieldAgent);
	pSketchState->AddDialogAgent(_pToolingDirFieldAgent);
	pSketchState->AddDialogAgent(_pSketchFieldAgent);

	CATDialogState *pToolingDirState = AddDialogState("Select Tooling Direction");
	pToolingDirState->AddDialogAgent(_pLineAgent);
	pToolingDirState->AddDialogAgent(_pSurfaceFieldAgent);
	pToolingDirState->AddDialogAgent(_pToolingDirFieldAgent);
	pToolingDirState->AddDialogAgent(_pSketchFieldAgent);


	//
	AddTransition(pSurfState,pSurfState,
		IsOutputSetCondition(_pSurfaceAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::SelectSurfaceFunc));

	AddTransition(pToolingDirState,pToolingDirState,
		IsOutputSetCondition(_pLineAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::SelectLineFunc));

	AddTransition(pSketchState,pSketchState,
		IsOutputSetCondition(_pSketchAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::SelectSketchFunc));

	//---> Surface
	AddTransition(pSurfState,pSurfState,
		IsOutputSetCondition(_pSurfaceFieldAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::TransToSurfFunc));

	AddTransition(pToolingDirState,pSurfState,
		IsOutputSetCondition(_pSurfaceFieldAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::TransToSurfFunc));

	AddTransition(pSketchState,pSurfState,
		IsOutputSetCondition(_pSurfaceFieldAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::TransToSurfFunc));


	//--->Tooling Direction
	AddTransition(pSurfState,pToolingDirState,
		IsOutputSetCondition(_pToolingDirFieldAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::TransToToolingDirFunc));

	AddTransition(pToolingDirState,pToolingDirState,
		IsOutputSetCondition(_pToolingDirFieldAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::TransToToolingDirFunc));

	AddTransition(pSketchState,pToolingDirState,
		IsOutputSetCondition(_pToolingDirFieldAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::TransToToolingDirFunc));


	//--->Opponent Doc
	AddTransition(pSurfState,pSketchState,
		IsOutputSetCondition(_pSketchFieldAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::TransToSketchFunc));

	AddTransition(pToolingDirState,pSketchState,
		IsOutputSetCondition(_pSketchFieldAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::TransToSketchFunc));

	AddTransition(pSketchState,pSketchState,
		IsOutputSetCondition(_pSketchFieldAgent),
		Action((ActionMethod)& TJMWheelHouseDraftCmd::TransToSketchFunc));

}


//-------------------------------------------------------------------------
// ActionOne ()
//-------------------------------------------------------------------------
CATBoolean TJMWheelHouseDraftCmd::ActionOne( void *data )
{
  // TODO: Define the action associated with the transition 
  // ------------------------------------------------------

  return TRUE;
}

//************************************
// Method:    ActionCancelFunc
// FullName:  ActionCancelFunc
// Access:    public 
// Returns:   CATBoolean
// Qualifier: cancel动作
// Parameter: void *data
//************************************
CATBoolean TJMWheelHouseDraftCmd::ActionCancelFunc(void * data)
{
	RequestDelayedDestruction();
	return TRUE;
}

//************************************
// Method:    ActionOKFunc
// FullName:  ActionOKFunc
// Access:    public 
// Returns:   CATBoolean
// Qualifier: ok动作
// Parameter: void *data
//************************************
CATBoolean TJMWheelHouseDraftCmd::ActionOKFunc(void * data)
{
	CATTime iStartTime = CATTime::GetCurrentLocalTime();

	if (!CheckInput())
	{
		TJMWheelHouseDraftGeneralClass::MessageOutputError("Please complete the selections first.","Error");
		return FALSE;
	}

	double dAngle=_pDlg->GetSpinnerFunc(DraftAngle)->GetValue();	//获取到的直接就是弧度，不需要再转换

	TJMWheelHouseDraftCls *pCls = new TJMWheelHouseDraftCls();
	pCls->SetDatas(&_spiRootProduct,&_spiSpecSurfaceWH,&_spBUSketch,&_spBUToolingDir,dAngle);
	pCls->ComputeResults2();

	if (pCls!=NULL)
	{
		delete pCls;
		pCls=NULL;
	}

	CATTime iEndTime1 = CATTime::GetCurrentLocalTime();
	CATTimeSpan iTimeSpan=iEndTime1-iStartTime;
	cout<<"=========> Calculate Run Time: "<<iTimeSpan.ConvertToString("%M:%S")<<endl;

	TJMWheelHouseDraftGeneralClass::MessageOutputInfo("Finished!","Info");
	RequestDelayedDestruction();
	return TRUE;
}

//************************************
// Method:    SelectSurfaceFunc
// FullName:  YFCNSLRearPanelFixStrcCmd::SelectSurfaceFunc
// Access:    public 
// Returns:   void
// Qualifier: 选择曲面
// Parameter: void *data
//************************************
void TJMWheelHouseDraftCmd::SelectSurfaceFunc(void * data)
{
	if (_pHSO!=NULL)	_pHSO->Empty();
	//if (_pISO!=NULL)	_pISO->Empty();

	CATBaseUnknown_var spBUSelect = NULL_var;
	CATIProduct_var spiProdSelect = NULL_var;
	CATISpecObject_var spiSpecSelect = NULL_var;
	//STTGeneralCls::TransferSelect(_pSurfaceAgent,spBUSelect,spiProdSelect);
	TJMWheelHouseDraftGeneralClass::TransferSelectToSpecObjOnTree(_pSurfaceAgent,spiSpecSelect,spiProdSelect);
	if (spiSpecSelect == NULL_var || spiProdSelect == NULL_var)
	{
		_pSurfaceAgent->InitializeAcquisition();
		return;
	}

	if (_intSelType==0)
	{
		_spiSpecSurfaceWH = spiSpecSelect;

		_pDlg->GetSelectorListFunc(0)->ClearLine();
		CATUnicodeString strAlias = TJMWheelHouseDraftGeneralClass::GetNameFromBaseUnknownFunc(spiSpecSelect);
		_pDlg->GetSelectorListFunc(0)->SetLine(strAlias,-1,CATDlgDataAdd);
		int iTabRow = 0;
		if (_spBUSketch==NULL_var)
		{
			_pDlg->GetSelectorListFunc(1)->SetSelect(&iTabRow,1);
		} 
		else
		{
			_pDlg->GetSelectorListFunc(0)->SetSelect(&iTabRow,1);
		}
		
	}

	_pSurfaceAgent->InitializeAcquisition();
}

void TJMWheelHouseDraftCmd::SelectSketchFunc(void * data)
{
	if (_pHSO!=NULL)	_pHSO->Empty();
	//if (_pISO!=NULL)	_pISO->Empty();

	CATBaseUnknown_var spBUSelect = NULL_var;
	CATIProduct_var spiProdSelect = NULL_var;
	CATISpecObject_var spiSpecSelect = NULL_var;
	//STTGeneralCls::TransferSelect(_pSurfaceAgent,spBUSelect,spiProdSelect);
	TJMWheelHouseDraftGeneralClass::TransferSelectToBU(_pSketchAgent,spBUSelect,spiProdSelect);
	if (spBUSelect == NULL_var || spiProdSelect == NULL_var)
	{
		_pSketchAgent->InitializeAcquisition();
		return;
	}

	if (_intSelType==1)
	{
		_spBUSketch = spBUSelect;

		_pDlg->GetSelectorListFunc(1)->ClearLine();
		CATUnicodeString strAlias = TJMWheelHouseDraftGeneralClass::GetNameFromBaseUnknownFunc(spBUSelect);
		_pDlg->GetSelectorListFunc(1)->SetLine(strAlias,-1,CATDlgDataAdd);
		int iTabRow = 0;
		if (_spBUToolingDir==NULL_var)
		{
			_pDlg->GetSelectorListFunc(2)->SetSelect(&iTabRow,1);
		}
		else
		{
			_pDlg->GetSelectorListFunc(1)->SetSelect(&iTabRow,1);
		}
	}

	_pSketchAgent->InitializeAcquisition();
}

//************************************
// Method:    SelectLineFunc
// FullName:  YFCNSLRearPanelFixStrcCmd::SelectLineFunc
// Access:    public 
// Returns:   void
// Qualifier: 选择直线
// Parameter: void *data
//************************************
void TJMWheelHouseDraftCmd::SelectLineFunc(void * data)
{
	if (_pHSO!=NULL)	_pHSO->Empty();
	//if (_pISO!=NULL)	_pISO->Empty();

	CATBaseUnknown_var spBUSelect = NULL_var;
	CATIProduct_var spiProdSelect = NULL_var;
	TJMWheelHouseDraftGeneralClass::TransferSelectToBU(_pLineAgent,spBUSelect,spiProdSelect);
	if (spBUSelect == NULL_var || spiProdSelect == NULL_var)
	{
		_pLineAgent->InitializeAcquisition();
		return;
	}

	if (_intSelType==2)
	{
		_spBUToolingDir = spBUSelect;

		_pDlg->GetSelectorListFunc(2)->ClearLine();
		CATUnicodeString strAlias = TJMWheelHouseDraftGeneralClass::GetNameFromBaseUnknownFunc(spBUSelect);
		_pDlg->GetSelectorListFunc(2)->SetLine(strAlias,-1,CATDlgDataAdd);
		int iTabRow = 0;
		_pDlg->GetSelectorListFunc(2)->SetSelect(&iTabRow,1);
	}

	_pLineAgent->InitializeAcquisition();
}

CATBoolean TJMWheelHouseDraftCmd::CheckSelectedElement(void * data)
{
	if (_intSelType==0)
	{
		CATISpecObject_var spiSpecSelect = NULL_var;
		CATIProduct_var spiProdSelect = NULL_var;
		TJMWheelHouseDraftGeneralClass::TransferSelectToSpecObjOnTree(_pSurfaceAgent,spiSpecSelect,spiProdSelect);
		if (spiSpecSelect == NULL_var || spiProdSelect == NULL_var || spiProdSelect!=_spiRootProduct)
		{
			return FALSE;
		}
		else
		{
			CATIMf3DAxisSystem_var spiAxisSys = spiSpecSelect;
			CATIMfInfiniteResult_var spiInfResult = spiSpecSelect;
			if (spiAxisSys!=NULL_var||spiInfResult!=NULL_var)
			{
				return FALSE;
			}
			CATIMfBiDimResult_var spiMfBiDimResult = spiSpecSelect;
			if (spiMfBiDimResult==NULL_var)
			{
				return FALSE;
			}
		}
	}
	else
	{
		CATBaseUnknown_var spBUSelect = NULL_var;
		CATIProduct_var spiProdSelect = NULL_var;

		if (_intSelType==1)
		{
			TJMWheelHouseDraftGeneralClass::TransferSelectToBU(_pSketchAgent,spBUSelect,spiProdSelect);
		} 
		else if (_intSelType==2)
		{
			TJMWheelHouseDraftGeneralClass::TransferSelectToBU(_pLineAgent,spBUSelect,spiProdSelect);
		}
		if (spBUSelect == NULL_var || spiProdSelect == NULL_var || spiProdSelect!=_spiRootProduct)
		{
			return FALSE;
		}
	}
	return TRUE;
}

//************************************
// Method:    TransToASurfFunc
// FullName:  YFCNSLRearPanelFixStrcCmd::TransToASurfFunc
// Access:    public 
// Returns:   void
// Qualifier: 切换到选择A面控件
// Parameter: void *data
//************************************
void TJMWheelHouseDraftCmd::TransToSurfFunc(void * data)
{
	_intSelType=0;
	
	InitializeControlsFunc(_intSelType);

	TJMWheelHouseDraftGeneralClass::SetHighlight(_spiSpecSurfaceWH,_pEditor,_pHSO);

}

//************************************
// Method:    TransToASurfFunc
// FullName:  YFCNSLRearPanelFixStrcCmd::TransToASurfFunc
// Access:    public 
// Returns:   void
// Qualifier: 切换到选择拔模线控件
// Parameter: void *data
//************************************
void TJMWheelHouseDraftCmd::TransToSketchFunc(void * data)
{
	_intSelType=1;

	InitializeControlsFunc(_intSelType);

	TJMWheelHouseDraftGeneralClass::SetHighlight(_spBUSketch,_pEditor,_pHSO);

}

//************************************
// Method:    TransToASurfFunc
// FullName:  YFCNSLRearPanelFixStrcCmd::TransToASurfFunc
// Access:    public 
// Returns:   void
// Qualifier: 切换到选择拔模线控件
// Parameter: void *data
//************************************
void TJMWheelHouseDraftCmd::TransToToolingDirFunc(void * data)
{
	_intSelType=2;

	InitializeControlsFunc(_intSelType);

	TJMWheelHouseDraftGeneralClass::SetHighlight(_spBUToolingDir,_pEditor,_pHSO);

}

//************************************
// Method:    InitializeControlsFunc
// FullName:  YFCNSLRearPanelFixStrcCmd::InitializeControlsFunc
// Access:    public 
// Returns:   void
// Qualifier: 重置控件
// Parameter: int iExcept
//************************************
void TJMWheelHouseDraftCmd::InitializeControlsFunc(int iExcept)
{
	if (_pHSO!=NULL)	_pHSO->Empty();
	//if (_pISO!=NULL)	_pISO->Empty();

	_pSurfaceFieldAgent->InitializeAcquisition();
	_pToolingDirFieldAgent->InitializeAcquisition();
	_pSketchFieldAgent->InitializeAcquisition();

	for (int i=0;i<=2;i++)
	{
		if (iExcept==i)
		{
			continue;
		}
		_pDlg->GetSelectorListFunc(i)->ClearSelect();
	}
}

void TJMWheelHouseDraftCmd::InitialDlg()
{
	//SelectorList
	CATUnicodeString strDefault="No Selection";
	for (int i=0;i<=2;i++)
	{
		_pDlg->GetSelectorListFunc(i)->SetLine(strDefault);
	}

	//spinner
	_pDlg->GetSpinnerFunc(0)->SetUnit(CATDlgControl::Degree);
	_pDlg->GetSpinnerFunc(0)->SetMinMaxStep(0,90*CATDegreeToRadian,CATDegreeToRadian);
	_pDlg->GetSpinnerFunc(0)->SetValue(4.5*CATDegreeToRadian);
	_pDlg->GetSpinnerFunc(0)->SetPrecision(1,TRUE);


	int iTabRow=0;
	_pDlg->GetSelectorListFunc(0)->SetSelect(&iTabRow,1);

}

CATBoolean TJMWheelHouseDraftCmd::CheckInput()
{
	if (_spiSpecSurfaceWH==NULL_var||_spBUSketch==NULL_var||_spBUToolingDir==NULL_var)
	{
		return FALSE;
	}
	return TRUE;
}