// COPYRIGHT Dassault Systemes 2018
//===================================================================
//
// YFAirventViewerFeedbackManager.cpp
// Header definition of YFAirventViewerFeedbackManager
//
//===================================================================
//
// Usage notes:
//
//===================================================================
//
//  Sep 2018  Creation: Code generated by the CAA wizard
//===================================================================
#include "YFAirventViewerFeedbackManager.h"

// ApplicationFrame framework 
#include "CATFrmLayout.h"
#include "CATFrmEditor.h"
#include "CATFrmWindow.h"
#include "CATAfrCheckHeaderAccessor.h"

// ObjectModelerBase framework
#include "CATIAlias.h"

// Visualization framework
#include "CAT2DAnnotationTextRep.h"
#include "CAT2DBagRep.h"
#include "CATViewer.h"
#include "CATVisViewerFeedbackEvent.h"
#include "CATGraphicElementIntersection.h"
#include "CATSO.h"
#include "CATPathElement.h"
#include "CATMathVector2Df.h"
#include "CATMathPoint2Df.h"
#include "CATSupport.h"
#include "CAT2DViewpoint.h"

// System framework
#include "CATUnicodeString.h"

//C++ standard library
#include <iostream.h>

// The unique class instance 
extern YFAirventViewerFeedbackManager * _ViewerFeedbackManager = NULL ;
 
CATImplementClass( YFAirventViewerFeedbackManager,
                   Implementation, 
                   CATBaseUnknown,
                   CATNull );
 
//-----------------------------------------------------------------------------
// YFAirventViewerFeedbackManager : constructor
//-----------------------------------------------------------------------------
YFAirventViewerFeedbackManager::YFAirventViewerFeedbackManager():
_ViewerFeedbackCB(0),
_WindowActivatedCB(0),
_WindowDeactivatedCB(0),
_WindowDeletedCB(0),
_pCurrentViewer(NULL),
_pInformationsToDisplay(NULL),
_piUnknown(NULL)
{
	//cout <<" YFAirventViewerFeedbackManager::YFAirventViewerFeedbackManager" << endl;
}

//-----------------------------------------------------------------------------
// YFAirventViewerFeedbackManager : destructor
//-----------------------------------------------------------------------------
YFAirventViewerFeedbackManager::~YFAirventViewerFeedbackManager()
{
	//cout <<" YFAirventViewerFeedbackManager::~YFAirventViewerFeedbackManager" << endl;

	// Unsets CB 
	if (0 != _WindowActivatedCB)
	{
		::RemoveCallback(this,CATFrmLayout::GetCurrentLayout(),_WindowActivatedCB) ;
		_WindowActivatedCB = 0 ;
	}

	if (0 != _WindowDeactivatedCB)
	{
		::RemoveCallback(this,CATFrmLayout::GetCurrentLayout(),_WindowDeactivatedCB) ;
		_WindowDeactivatedCB = 0 ;
	}

	if (0 != _WindowDeletedCB)
	{
		::RemoveCallback(this,CATFrmLayout::GetCurrentLayout(),_WindowDeletedCB) ;
		_WindowDeletedCB = 0 ;
	}


	SetViewerFeedbackOff();
	_pCurrentViewer =  NULL ;
	_pInformationsToDisplay = NULL ;
}
 
//-----------------------------------------------------------------------------
// YFAirventViewerFeedbackManager : copy constructor
//-----------------------------------------------------------------------------
YFAirventViewerFeedbackManager::YFAirventViewerFeedbackManager(YFAirventViewerFeedbackManager& original):
   CATBaseUnknown(original)
{
}
 
//-----------------------------------------------------------------------------
// YFAirventViewerFeedbackManager : equal operator
//-----------------------------------------------------------------------------
YFAirventViewerFeedbackManager& YFAirventViewerFeedbackManager::operator=(YFAirventViewerFeedbackManager& original)
{
   CATBaseUnknown::operator=(original);
   return *this;
}
 
void YFAirventViewerFeedbackManager::GetManager(YFAirventViewerFeedbackManager ** opManager)
{
	if ( NULL != opManager )
	{      
		*opManager = NULL ;

		//if ( NULL != _ViewerFeedbackManager )
		//{
		//	*opManager = _ViewerFeedbackManager ;
		//	_pCurrentViewer = NULL;
		//}else
		//{
			*opManager = new YFAirventViewerFeedbackManager() ;

			_ViewerFeedbackManager = *opManager ;
		//}

		if ( NULL != (*opManager))
		{
			(*opManager)->AddRef();
		}
	}
}

//-------------------------------------------------------------------------
void YFAirventViewerFeedbackManager::SetViewerFeedbackOn()
{
	//cout << " YFAirventViewerFeedbackManager::SetViewerFeedbackOn" << endl;
	// Sets visual feedback on the current viewer
	//
	if ( NULL == _pCurrentViewer )
	{
		// Retrieves a viewer
		CATFrmLayout * pCurrentLayout= CATFrmLayout::GetCurrentLayout();
		if ( NULL != pCurrentLayout )
		{
			CATFrmWindow * pCurrentWindow = pCurrentLayout->GetCurrentWindow();

			if ( NULL != pCurrentWindow )
			{
				// it is a choice to take the first wiever given by the window
				_pCurrentViewer = pCurrentWindow->GetViewer();
			}
		}

		// Sets feedback mode to the viewer
		if ( NULL != _pCurrentViewer )
		{
			// The feedback mode is activated, the viewer will send
			// CATVisViewerFeedbackEvent notifications that this class
			// will catch thanks to a callback. 
			//
			_pCurrentViewer->SetFeedbackMode(TRUE);

			// Sets CB to update the current viewer 
			//
			if (0 == _ViewerFeedbackCB)
			{
				// Callback to be prevent at each CATVisViewerFeedbackEvent 
				// event sending.
				//
				_ViewerFeedbackCB = ::AddCallback(this,
					_pCurrentViewer, 
					CATViewer::VIEWER_FEEDBACK_UPDATE(), 
					(CATSubscriberMethod) & YFAirventViewerFeedbackManager::ViewerFeedbackCB, NULL);
			}
		}
	} 

	//
	// Callback to be prevent at each window event sending.
	//
	if (0 == _WindowActivatedCB)
	{
		_WindowActivatedCB = ::AddCallback(this,
			CATFrmLayout::GetCurrentLayout(), 
			CATFrmWindow::WINDOW_ACTIVATED(),
			(CATSubscriberMethod) & YFAirventViewerFeedbackManager::WindowActivatedCB, NULL);
	}
	if (0 == _WindowDeactivatedCB)
	{
		_WindowDeactivatedCB = ::AddCallback(this,
			CATFrmLayout::GetCurrentLayout(), 
			CATFrmWindow::WINDOW_DEACTIVATED(),
			(CATSubscriberMethod) & YFAirventViewerFeedbackManager::WindowDeactivatedCB, NULL);
	}
	if (0 == _WindowDeletedCB)
	{
		_WindowDeletedCB = ::AddCallback(this,
			CATFrmLayout::GetCurrentLayout(), 
			CATFrmWindow::WINDOW_DELETED(),
			(CATSubscriberMethod) & YFAirventViewerFeedbackManager::WindowDeactivatedCB, NULL);
	}

}

//-------------------------------------------------------------------------
void YFAirventViewerFeedbackManager::SetViewerFeedbackOff()
{
	//cout << " YFAirventViewerFeedbackManager::SetViewerFeedbackOff" << endl;
	// Unsets visual feedback on the current viewer and 
	// deletes the graphic representation
	//
	if ( NULL != _pCurrentViewer)
	{
		_pCurrentViewer->SetFeedbackMode(FALSE);

		if (NULL != _pInformationsToDisplay)
		{
			// The graphic representation is removed from
			// the main 2D viewpoint of the viewer
			//
			_pCurrentViewer->RemoveRep(_pInformationsToDisplay);

			// graphic representation deletion
			_pInformationsToDisplay->Destroy();
			_pInformationsToDisplay = NULL;
		}

		// To refresh the viewer
		_pCurrentViewer->Draw();

		// Unsets CB to update the viewer 
		if (0 != _ViewerFeedbackCB)
		{
			::RemoveCallback(this,_pCurrentViewer,_ViewerFeedbackCB) ;
			_ViewerFeedbackCB = 0 ;
		}

		// 
		_pCurrentViewer = NULL ; 
	}

}

//-------------------------------------------------------------------------

void YFAirventViewerFeedbackManager::ViewerFeedbackCB( CATCallbackEvent   event,
												   void             * client,
												   CATNotification  * iNotification,
												   CATSubscriberData  data,
												   CATCallback        callback)
{
	_piUnknown = NULL;
	if ( NULL != _pCurrentViewer )
	{
		//
		// 1- Removes the previous graphic representation from the viewer 
		//
		if (NULL != _pInformationsToDisplay)
		{
			_pCurrentViewer->RemoveRep(_pInformationsToDisplay);

			// To delete a rep, you should use the Destroy method 
			//
			_pInformationsToDisplay->Destroy();
			_pInformationsToDisplay = NULL;
		}

		//
		// 2- Retrieves the nodification contained by the event
		//
		CATVisViewerFeedbackEvent * pFeedbackEvent = NULL ;
		if ( NULL != iNotification )
		{
			pFeedbackEvent = (CATVisViewerFeedbackEvent*) iNotification;
		}

		if (NULL != pFeedbackEvent)
		{
			//
			// 2-a Retrieves the publisher viewer
			// and checks that it is the same as our current viewer
			//
			CATViewer * pViewerPublisher = pFeedbackEvent->GetViewer();

			if ( (NULL != pViewerPublisher) && ( pViewerPublisher == _pCurrentViewer) )
			{

				_pInformationsToDisplay = new CAT2DBagRep();
				//_pCurrentViewer->AddRep(_pInformationsToDisplay);

				// The notification contains information to display:
				//  A- Mouse position
				//  B- Intersection point with the geometry  (the point can be null)
				//  C- List of objects under the mouse (the list can be empty)
				//

				//
				// A- Mouse position in screen coordinates
				//
				int XPos, YPos;
				pFeedbackEvent->GetMousePosition(&XPos, &YPos);
				_math2DPt.SetCoord((double)XPos, (double)YPos);
				//cout<<"The screen Point is: "<<XPos<<","<<YPos<<endl;

				// Modifies the bag position 
				ChangeBagPosition(XPos,YPos);

				float points[2];
				points[0] = 8.0f;
				points[1] = 8.0f;

				char MousePositionBuffer[200];
				sprintf(MousePositionBuffer, "Mouse Coordinates : X=%d Y=%d", XPos, YPos);

				CAT2DAnnotationTextRep * pMousePositionTextRep = NULL ;
				pMousePositionTextRep = new CAT2DAnnotationTextRep( points, 
					MousePositionBuffer, 
					BASE_LEFT);

				if (NULL != pMousePositionTextRep)
				{
					_pInformationsToDisplay->AddChild(*pMousePositionTextRep);
				}

				//
				// B- Intersection point between the mouse and the underlying geometry
				//    the point is in model coordinates

				CATGraphicElementIntersection* pIntersection = pFeedbackEvent->GetIntersection();

				if (NULL != pIntersection)
				{
					points[1] += 8.0f;

					char IntersectionBuffer[200];

					sprintf(IntersectionBuffer, 
						"Intersection Coordinates : X=%.2f Y=%.2f Z=%.2f", 
						pIntersection->point.GetX(), 
						pIntersection->point.GetY(), 
						pIntersection->point.GetZ());

					_mathPickPt.SetX(pIntersection->point.GetX());
					_mathPickPt.SetY(pIntersection->point.GetY());
					_mathPickPt.SetZ(pIntersection->point.GetZ());

					CAT2DAnnotationTextRep * pIntersectionTextRep = NULL ;
					pIntersectionTextRep = new CAT2DAnnotationTextRep( points, 
						IntersectionBuffer, BASE_LEFT);

					if (NULL != pIntersectionTextRep)
					{
						_pInformationsToDisplay->AddChild(*pIntersectionTextRep);
					}

					pIntersection->Release();
					pIntersection = NULL;
				}

				//
				// C- Displays the list of elements under the mouse
				//
				CATSO* SO = pFeedbackEvent->GetElementsUnder();

				if (NULL != SO)
				{
					CATPathElement * ipPath = (CATPathElement*) ((*SO)[0]) ;
					if(ipPath!=NULL)
					{
						int intiLeafSize = ipPath->GetSize() ;
						if(intiLeafSize>0)
						{
							_piUnknown= (*ipPath)[intiLeafSize-1] ;
							//if(_piUnknown!=NULL)
							//{
							//	CATIAlias * pIAliasOnElt = NULL ;
							//	rc = _piUnknown->QueryInterface (IID_CATIAlias, (void**) &pIAliasOnElt);
							//	if (SUCCEEDED(rc)&&pIAliasOnElt!=NULL)
							//	{
							//		std::cout<<pIAliasOnElt->GetAlias().ConvertToChar()<<std::endl;
							//		pIAliasOnElt->Release();
							//		pIAliasOnElt=NULL;
							//	}
							//}
						}
					}

					//for ( int i= 0 ; i < SOSize ; i++)
					//{
					//	CATPathElement * pPathElement = (CATPathElement*) ((*SO)[i]) ;

					//	// Transforms a path element in a string
					//	CATUnicodeString PathElementName = "";
					//	PathElementString(pPathElement,PathElementName);

					//	// Adds the indice of the element 
					//	char Buffer[200];
					//	sprintf(Buffer, "   : %d / %d", i+1,SO->GetSize());

					//	CATUnicodeString Count(Buffer);
					//	PathElementName.Append(Buffer) ;

					//	points[1] += 8.0f;

					//	CAT2DAnnotationTextRep* pElementTextRep = NULL ;
					//	pElementTextRep = new CAT2DAnnotationTextRep( points, 
					//		PathElementName.ConvertToChar(), 
					//		BASE_LEFT);

					//	if (NULL != pElementTextRep)
					//	{
					//		_pInformationsToDisplay->AddChild(*pElementTextRep);
					//	}
					//}

					SO->Release();
					SO = NULL;
				}
			}

			if ( pViewerPublisher != NULL )
			{
				pViewerPublisher->Release();
				pViewerPublisher = NULL ;
			}
		}

		//
		// 3- Refreshes the viewer
		//
		_pCurrentViewer->Draw();
	}

}

//-------------------------------------------------------------------------

void YFAirventViewerFeedbackManager::PathElementString(CATPathElement * ipPath, 
													CATUnicodeString & oPathName)
{

	oPathName = "" ;
	if ( NULL != ipPath )
	{
		int sizeOfThePath = ipPath->GetSize();  

		for ( int i = 0 ; i < sizeOfThePath ; i++ )
		{
			CATBaseUnknown * pElt = (*ipPath)[i] ;
			if ( NULL != pElt )
			{
				CATIAlias * pIAliasOnElt = NULL ;
				HRESULT rc = pElt->QueryInterface (IID_CATIAlias, (void**) &pIAliasOnElt);
				if (SUCCEEDED(rc) )
				{
					CATUnicodeString Name = pIAliasOnElt->GetAlias();
					oPathName.Append(Name) ;

					if ( i <= (sizeOfThePath-2) )
					{
						oPathName.Append("/"); ;
					}

					pIAliasOnElt->Release();
					pIAliasOnElt = NULL ;
				}
			}
		}
	}
}

//-------------------------------------------------------------------------

void YFAirventViewerFeedbackManager::ChangeBagPosition(float Xpos, float Ypos)
{
	// Transforms Xpos and Ypos ( screen coordinates) in model coordinates
	// and translates the bag at this position
	//
	if ( (NULL != _pInformationsToDisplay) && ( NULL != _pCurrentViewer) )
	{
		// Retrieves the support characteristics
		CATSupport & Support = _pCurrentViewer->GetSupport();

		float width, height, MMInSupportUnit, RatioWH ;

		Support.GetWidthAndHeight(width, height);

		MMInSupportUnit = Support.GetMMInSupportUnit();
		RatioWH = Support.GetRatioWH();

		// Retrieves the 2D VP
		CAT2DViewpoint & VP2D = _pCurrentViewer->GetMain2DViewpoint() ;

		// Transforms the position (in screen coordinates) in model coordinates
		CATMathPoint2Df ModelPos;
		VP2D.ComputeModelFromPixel( Xpos,Ypos, 
			ModelPos.x, ModelPos.y, 
			width, height, 
			MMInSupportUnit, 
			RatioWH);

		// Translates the bag ModelPos
		CATMathVector2Df U,V ;
		CAT3x3Matrix Matrix(U,V,ModelPos);
		_pInformationsToDisplay->SetMatrix(Matrix);
	}
}

//-------------------------------------------------------------------------

void YFAirventViewerFeedbackManager::WindowActivatedCB( CATCallbackEvent   event,
													void             * client,
													CATNotification  * notification,
													CATSubscriberData  data,
													CATCallback        callback)
{
	//cout << " YFAirventViewerFeedbackManager::WindowActivatedCB"  << endl;

	// A window is activated: after its creation, or when the end user selects it.
	// If the CAAAfrViewerFeedbackHdr check header is with the check state 
	// the feedback mode will be activated on the viewer of this window.
	//
	CATAfrCheckHeaderAccessor ViewerFeedbackHdrAcc("CAAAfrViewerFeedbackHdr") ;
	if( 1 == ViewerFeedbackHdrAcc.IsChecked() )
	{
		SetViewerFeedbackOn();   
	}
}

//-------------------------------------------------------------------------

void YFAirventViewerFeedbackManager::WindowDeactivatedCB( CATCallbackEvent   event,
													  void             * client,
													  CATNotification  * notification,
													  CATSubscriberData  data,
													  CATCallback        callback)
{
	//cout << " YFAirventViewerFeedbackManager::WindowDeactivatedCB"  << endl;

	// A window is deactivated: by its closure, or when the end user selects an other one.
	// The feedback mode will be deactivated. The same check as in the previous method 
	// can be done but it is not mandatory, the SetViewerFeedbackOff checks that
	// _pCurrentViewer is not nul : the feedback mode was active.
	//
	SetViewerFeedbackOff();

}

//描述：获取屏幕中的三维点
//输入：
//输出：CATMathPoint
//返回：CATMathPoint
CATMathPoint YFAirventViewerFeedbackManager::GetScreenPickedPoint()
{
	return _mathPickPt;
}

//描述：获取屏幕中的二维点
//输入：
//输出：CATMathPoint2D
//返回：CATMathPoint2D
CATMathPoint2D YFAirventViewerFeedbackManager::GetScreen2DPoint()
{
	return _math2DPt;
}

//描述：获取屏幕中的对象
//输入：
//输出：CATBaseUnknown
//返回：CATBaseUnknown
CATBaseUnknown *YFAirventViewerFeedbackManager::GetPickedObject()
{
	return _piUnknown;
}